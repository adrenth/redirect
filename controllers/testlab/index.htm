<?= Form::open(['class' => 'layout']) ?>

<input type="hidden" id="redirectCount" value="<?= $redirectCount ?>">
<div class="row test-lab">
    <?php if ($redirectCount !== 0): ?>
    <div class="col-md-10">
        <div class="progress">
            <div class="progress-bar"
                 id="progressBar"
                 role="progressbar"
                 aria-valuenow="0"
                 aria-valuemin="0"
                 aria-valuemax="100"
                 style="width:0">
            </div>
        </div>
        <p id="progress" data-initial="Press the 'Start tests' button to begin.">
            Press the 'Start tests' button to begin.
        </p>
    </div>
    <div class="col-md-2">
        <button class="btn btn-primary btn-block input-lg"
                id="testButton"
                type="button"
                onclick="start();">
            Start tests
        </button>
    </div>

    <div class="col-md-12" id="testerResults"></div>
    <?php else: ?>
    <div class="col-md-12">
        <div class="callout fade in callout-warning">
            <button type="button"
                    class="close"
                    data-dismiss="callout"
                    aria-hidden="true">&times;
            </button>
            <div class="content">
                <p>No redirects have been marked with TestLab enabled. Please enable the option 'Include in
                    TestLab' when editing a redirect.</p>
            </div>
        </div>
    </div>
    <?php endif; ?>
</div>

<?= Form::close() ?>

<script type="text/javascript">
    function testerExecute(offset, total) {
        $.request('onTest', {
            data: {
                offset: offset
            },
            success: function (data) {
                if (data.result === '' || typeof data.result === 'undefined') {
                    updateStatusBar(total, total);
                    return;
                }

                $('#testerResults').prepend(data.result);

                updateStatusBar(total, offset);

                if (offset + 1 !== total) {
                    testerExecute(offset + 1, total);
                }
            }
        });
    }

    function start() {
        updateStatusBar(0);

        $('#testerResults').html('');

        testerExecute(0, $('#redirectCount').val());
    }

    function updateStatusBar(total, offset)
    {
        var width = 0;

        if (total > 0) {
            width = Math.ceil(100 / total * offset);
        }

        var progress = $('#progress');
            progress.html(width + '% complete');

        var progressBar = $('#progressBar');
            progressBar.attr('aria-valuenow', width);
            progressBar.css('width', width + '%');

        if (width === 0) {
            progress.html(progress.data('initial'));
        }
    }
</script>
